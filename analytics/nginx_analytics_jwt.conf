# NGINX Configuration for Analytics Dashboard with JWT Authentication
# This config should be included in your main NGINX server block for api.haze.pro

# Login page (no authentication required)
location /login {
    proxy_pass http://127.0.0.1:8089/login;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Analytics Dashboard Location Block (requires JWT authentication)
location /analytics/ {
    # JWT Authentication via auth_request
    auth_request /api/auth/verify-token;
    
    # Pass authentication errors to user
    error_page 401 = @analytics_auth_error;
    error_page 403 = @analytics_auth_error;
    
    # Proxy to Analytics server
    proxy_pass http://127.0.0.1:8089/analytics/;
    
    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Pass Authorization header to backend
    proxy_set_header Authorization $http_authorization;
}

# Auth verification endpoint (proxies to Flask backend)
location = /api/auth/verify-token {
    internal;  # Only accessible for internal auth_request
    proxy_pass http://172.18.0.2:5070/api/auth/verify-token;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header Authorization $http_authorization;
}

# Error handler for authentication failures (redirects to login page)
location @analytics_auth_error {
    # Redirect to login page with return URL
    return 302 https://api.haze.pro/login?redirect=/analytics/analytics_dashboard.html;
}

# Alternative: JSON error response (for API clients)
# Uncomment if you prefer JSON errors instead of login redirect:
# location @analytics_auth_error {
#     default_type application/json;
#     return 401 '{"error": "Authentication required", "message": "Please provide a valid JWT token in the Authorization header"}';
# }
